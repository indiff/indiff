name: Build MySQL with docker images

on:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - '**/mysql-rocksdb.yml'  
  # pull_request:
  #   branches:
  #     - main
  workflow_dispatch:
    inputs:
      buildOnly:
        description: 'Only build target'
        type: boolean
        default: false
        required: false
      mysql_build_branch:
        description: 'Build mysql Branch'
        type: choice
        default: ""
        required: false
        options:
          - "trunk" 
          - "8.0" 
          - "8.4"
      fbmysql_build_branch:
        description: 'Build fbmysql Branch'
        type: choice
        default: ""
        required: false
        options:
          - "fb-mysql-8.0.32"
          - "fb-mysql-8.0.28" 
          - "fb-mysql-8.0.17" 
      mariadb_build_branch:
        description: 'Build mariadb Branch'
        type: choice
        default: ""
        required: false
        options:
          - "main"
          - "12.1" 
          - "12.0" 
          - "11.8" 
      percona_build_branch:
        description: 'Build percona Branch'
        type: choice
        default: ""
        required: false
        options:
          - "8.0"
          - "trunk"
          
  schedule:
    #- cron: '07 10 * * *' # 每天凌晨2点（UTC），对应每天上午10点（CST）, 这里对应的是中国时区的是 18 点
    - cron: '3 7 * * *' # UTC 时间 1:00 对应中国时间 9:00          
env:
  gcc_indiff_ubuntu_url: "https://github.com/indiff/gcc-build/releases/download/20250416_1126/gcc-indiff-ubuntu-x86_64-20250416_1125.xz"
  gcc_indiff_centos7_url: "https://github.com/indiff/gcc-build/releases/download/20250908_0934_16.0.0/gcc-indiff-centos7-16.0.0-x86_64-20250908_0931.xz"
  MYSQL_BRANCH: "${{ github.event.inputs.mysql_build_branch }}"          # mysql
  VCPKG_ROOT: "/opt/vcpkg"
  # 打包前安装根目录
  MYSQL_INSTALL_PREFIX: "/opt/mysql"
  # for fb mysql
  FBMYSQL_BRANCH: "${{ github.event.inputs.fbmysql_build_branch }}"
  FBMYSQL_INSTALL_PREFIX: "/opt/fbmysql"
  MARIADB_BRANCH: "${{ github.event.inputs.mariadb_build_branch }}"
  MARIADB_INSTALL_PREFIX: "/opt/mariadb"
  PERCONA_BRANCH: "${{ github.event.inputs.percona_build_branch }}"
  PERCONA_INSTALL_PREFIX: "/opt/percona80"
jobs:
  build_image:
    name: Build image
    if: ${{ github.event.inputs.buildOnly != 'true' }}
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-latest,ubuntu-24.04-arm]
        target: [mysql,fbmysql,percona,mariadb,demo]
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free Disk-Space
        run: df -h && sudo apt-get clean && docker system prune -a -f && sudo rm -rf /opt/ghc /usr/local/.ghcup /usr/local/lib/android && df -h && docker search ubuntu
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config: .github/buildkit.toml
          driver-opts: image=ghcr.io/btbn/buildkit:master

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
          # password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.target }}-build-centos7
          tags: |
            type=raw,value=latest
            type=sha,prefix=          
      - name: Generate Docker cache key
        id: cachekey
        run: |
          # cat images/${{ matrix.target }}-build/Dockerfile images/${{ matrix.target }}-build/centos7.sh
          CACHE_KEY=$(cat images/${{ matrix.target }}-build/Dockerfile images/${{ matrix.target }}-build/centos7.sh | sha256sum | cut -d' ' -f1)
          echo "cache_key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "Docker cache key: ${CACHE_KEY}"  build-${{ matrix.target }}-centos7:
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: images/${{ matrix.target }}-build
          push: true
          pull: true
          provenance: false
          # tags: ${{ steps.meta.outputs.tags }}
          # labels: ${{ steps.meta.outputs.labels }}
          # cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.target }}-build-centos7:latest
          # cache-to: type=inline
          tags: ${{ matrix.target }}-build-centos7:latest${{ (contains(matrix.runner, 'arm') && '-arm') || '' }}
          cache-to: type=registry,mode=max,ref=${{ matrix.target }}-build-centos7:cache${{ (contains(matrix.runner, 'arm') && '-arm') || '' }}
          cache-from: type=registry,ref=${{ matrix.target }}-build-centos7:cache${{ (contains(matrix.runner, 'arm') && '-arm') || '' }}
          build-args: |
            CACHE_KEY=ghcr.io/${{ steps.cachekey.outputs.cache_key }}
            gcc_indiff_centos7_url=${{ env.gcc_indiff_centos7_url }}
          # build-args: |
          #   MYSQL_BRANCH=${{ env.MYSQL_BRANCH }}
          #   INSTALL_PREFIX=${{ env.INSTALL_PREFIX }}
          #   VCPKG_ROOT=${{ env.VCPKG_ROOT }}
          #   FBMYSQL_BRANCH=${{ env.FBMYSQL_BRANCH }}
          #   FBMYSQL_INSTALL_PREFIX=${{ env.FBMYSQL_INSTALL_PREFIX }}
          #   MARIADB_BRANCH=${{ env.MARIADB_BRANCH }}
          #   MARIADB_INSTALL_PREFIX=${{ env.MARIADB_INSTALL_PREFIX }}
          #   gcc_indiff_centos7_url=${{ env.gcc_indiff_centos7_url }}
      - name: Cleanup
        continue-on-error: true
        uses: BtbN/delete-untagged-ghcr-action@main
        with:
          token: ${{ github.token }}
          package_name: ${{ matrix.target }}-build-centos7
          repository_owner: ${{ github.repository_owner }}
          repository: ${{ github.repository }}
          owner_type: user
          untagged_only: true
  build_target:
    runs-on: ubuntu-latest
    name: Build target
    if: ${{ ( github.event.inputs.buildOnly == 'true' && !cancelled() ) || success() }}
    needs: build_image
    strategy:
      fail-fast: false
      matrix:
        target: [mysql,fbmysql,percona,mariadb,demo]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build ${{ matrix.target }} in Docker
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          ls
          cat > run-config.sh <<'EOF'
          VCPKG_ROOT=${{ env.VCPKG_ROOT }}
          MYSQL_BRANCH='${{ env.MYSQL_BRANCH }}'
          MYSQL_INSTALL_PREFIX='${{ env.MYSQL_INSTALL_PREFIX }}'
          FBMYSQL_BRANCH='${{ env.FBMYSQL_BRANCH }}'
          FBMYSQL_INSTALL_PREFIX='${{ env.FBMYSQL_INSTALL_PREFIX }}'
          MARIADB_BRANCH='${{ env.MARIADB_BRANCH }}'
          MARIADB_INSTALL_PREFIX='${{ env.MARIADB_INSTALL_PREFIX }}'
          gcc_indiff_centos7_url='${{ env.gcc_indiff_centos7_url }}'
          EOF
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -v "$PWD/run-config.sh":/etc/indiff/run-config.sh:ro \
            ghcr.io/${{ github.repository_owner }}/${{ matrix.target }}-build-centos7:latest \
            /bin/bash -c "ls -ll && source /etc/indiff/run-config.sh && sh ./images/${{ matrix.target }}-build/${{ matrix.target }}-build.sh"
      - name: Upload ${{ matrix.target }} package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-centos7-x86_64
          path: |
            ${{ github.workspace }}/${{ matrix.target }}*.xz
  build-mysql-centos7:       
    runs-on: ubuntu-latest
    if: false
    #timeout-minutes: 120
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free Disk-Space
        run: df -h && sudo apt-get clean && docker system prune -a -f && sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc && df -h && free -h

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/mysql-build-centos7
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Generate Docker cache key
        id: cache-key
        run: |
          cat images/mysql-build/Dockerfile images/mysql-build/centos7.sh
          CACHE_KEY=$(cat images/mysql-build/Dockerfile images/mysql-build/centos7.sh | sha256sum | cut -d' ' -f1)
          echo "cache_key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "Docker cache key: ${CACHE_KEY}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: images/mysql-build
          push: true
          pull: true
          provenance: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/mysql-build-centos7:latest
          cache-to: type=inline
          build-args: |
            MYSQL_BRANCH=${{ env.MYSQL_BRANCH }}
            VCPKG_ROOT=${{ env.VCPKG_ROOT }}
            INSTALL_PREFIX=${{ env.INSTALL_PREFIX }}
            gcc_indiff_centos7_url=${{ env.gcc_indiff_centos7_url }}

      - name: Build mysql in Docker
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          ls
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e MYSQL_BRANCH=${{ env.MYSQL_BRANCH }} \
            -e VCPKG_ROOT=${{ env.VCPKG_ROOT }} \
            -e INSTALL_PREFIX=${{ env.INSTALL_PREFIX }} \
            -e gcc_indiff_centos7_url=${{ env.gcc_indiff_centos7_url }} \
            ghcr.io/${{ github.repository_owner }}/mysql-build-centos7:latest \
            /bin/bash -c "ls -ll && sh ./images/mysql-build/mysql-build.sh"

      - name: Upload mysql package
        uses: actions/upload-artifact@v4
        with:
          name: mysql-centos7-x86_64
          path: |
            ${{ github.workspace }}/mysql*.xz
  build-fbmysql-centos7:
    runs-on: ubuntu-latest
    if: false
    #timeout-minutes: 120
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free Disk-Space
        run: df -h && sudo apt-get clean && docker system prune -a -f && sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc && df -h && free -h

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/fbmysql-build-centos7
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Generate Docker cache key
        id: cache-key
        run: |
          cat images/fbmysql-build/Dockerfile images/fbmysql-build/centos7.sh
          CACHE_KEY=$(cat images/fbmysql-build/Dockerfile images/fbmysql-build/centos7.sh | sha256sum | cut -d' ' -f1)
          echo "cache_key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "Docker cache key: ${CACHE_KEY}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: images/fbmysql-build
          push: true
          pull: true
          provenance: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/fbmysql-build-centos7:latest
          cache-to: type=inline
          build-args: |
            FBMYSQL_BRANCH=${{ env.FBMYSQL_BRANCH }}
            VCPKG_ROOT=${{ env.VCPKG_ROOT }}
            FBMYSQL_INSTALL_PREFIX=${{ env.FBMYSQL_INSTALL_PREFIX }}
            gcc_indiff_centos7_url=${{ env.gcc_indiff_centos7_url }}

      - name: Build mysql in Docker
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          ls
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e FBMYSQL_BRANCH=${{ env.FBMYSQL_BRANCH }} \
            -e VCPKG_ROOT=${{ env.VCPKG_ROOT }} \
            -e FBMYSQL_INSTALL_PREFIX=${{ env.FBMYSQL_INSTALL_PREFIX }} \
            -e gcc_indiff_centos7_url=${{ env.gcc_indiff_centos7_url }} \
            ghcr.io/${{ github.repository_owner }}/fbmysql-build-centos7:latest \
            /bin/bash -c "ls -ll && sh ./images/fbmysql-build/fbmysql-build.sh"

      - name: Upload mysql package
        uses: actions/upload-artifact@v4
        with:
          name: fbmysql-centos7-x86_64
          path: |
            ${{ github.workspace }}/fbmysql*.xz
            
  publish-release:
      #needs: [build-mysql-centos7,build-fbmysql-centos7] 
      needs: [build_target] 
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v5
        - name: Restoring artifacts
          uses: actions/download-artifact@main
          with:
            path: artifacts
            pattern: "*-centos7-x86_64"
            merge-multiple: false
          
        - name: Release Tag
          id: release_tag
          run: |
            # sudo add-apt-repository ppa:ubuntu-toolchain-r/test
            # sudo apt update
            # sudo add-apt-repository ppa:ubuntu-toolchain-r/ppa
            # sudo apt upgrade
            sudo apt install -y chrony
            sudo systemctl enable chrony
            sudo systemctl start chrony
            sudo timedatectl set-timezone Asia/Shanghai
            timedatectl status
            echo "TAG_NAME=$(date +'%Y%m%d_%H%M')_mysql" >> $GITHUB_ENV

        - name: Create Release
          run: |
            set -xe
            sudo apt-get update
            sudo apt-get install -y zip unzip systemd language-pack-zh-hans language-pack-zh-hans-base locales tree
            sudo locale-gen zh_CN.UTF-8; /usr/bin/localectl set-locale LANG=zh_CN.UTF-8 || true ; 
            /usr/bin/timedatectl set-timezone Asia/Shanghai || true; 
            /usr/bin/timedatectl set-ntp true || true;
            # 使用 GitHub API 获取最后一次提交信息
            commit_info=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/percona/percona-server/commits \
            | jq -r '.[0] | "\(.commit.author.name) \(.commit.message) \(.commit.author.date)"')
            tree .
            # 输出变量
            echo "Commit Info: $commit_info"
            echo -e "## 你好$(date) percona \n > $commit_info\n" > hello.md

            commit_info=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/mariadb/server/commits \
            | jq -r '.[0] | "\(.commit.author.name) \(.commit.message) \(.commit.author.date)"')

            echo -e "## mariadb \n > $commit_info\n" >> hello.md
            cat <<'EOF' >> hello.md
            Proxy download:
            ```bash         
            curl -#Lo /opt/percona80.zip "https://ghproxy.cfd/https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit1centos7"
            ```
            ```bash         
            curl -#Lo /opt/mariadb.zip "https://ghproxy.cfd/https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit2centos7"
            ```
            ```bash         
            curl -#Lo /opt/percona80.zip "https://ghproxy.cfd/https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit3ubuntu"
            ```
             ```bash         
            curl -#Lo /opt/fbmysql.zip "https://ghproxy.cfd/https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit5centos7"
            ```
             ```bash         
            curl -#Lo /opt/omysql.zip "https://ghproxy.cfd/https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit6centos7"
            ```
            
            Direct download:
            ```bash         
            curl -#Lo /opt/percona80.zip "https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit1centos7"
            ```
             ```bash         
            curl -#Lo /opt/mariadb.zip "https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit2centos7"
            ```
             ```bash         
            curl -#Lo /opt/percona80.zip "https://github.com/indiff/indiff/releases/download/${{ env.TAG_NAME }}/shit3ubuntu"
            ```
            EOF
            centos7_fbmysql_bname="$(basename artifacts/*mysql*/*fbmysql*centos7*.xz)"
            centos7_omysql_bname="$(basename artifacts/*mysql*/*omysql*centos7*.xz)"
            centos7_percona_bname="$(basename artifacts/*mysql*/*percona*centos7*.xz)"
            centos7_mariadb_bname="$(basename artifacts/*mysql*/*mariadb*centos7*.xz)"
            ubuntu_percona_bname="$(basename artifacts/*mysql*/*percona*ubuntu*.xz)"
            sed -i "s/shit1centos7/${centos7_percona_bname}/g" hello.md
            sed -i "s/shit2centos7/${centos7_mariadb_bname}/g" hello.md
            sed -i "s/shit3ubuntu/${ubuntu_percona_bname}/g" hello.md
            sed -i "s/shit5centos7/${centos7_fbmysql_bname}/g" hello.md
            sed -i "s/shit6centos7/${centos7_omysql_bname}/g" hello.md

            gh release create ${{ env.TAG_NAME }} -F hello.md "artifacts/*/*.xz"
          env:
            GITHUB_TOKEN: ${{ github.token }}
