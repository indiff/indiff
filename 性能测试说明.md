# PostgreSQL vs MySQL 性能测试说明

## 概述

本项目包含了一个自动化的 GitHub Actions 工作流，用于对比 PostgreSQL 和 MySQL (Percona Server) 在相同环境下的性能表现。

## 测试工具

- **Sysbench**: 业界标准的数据库性能测试工具
- **测试环境**: Ubuntu Latest (GitHub Actions Runner)

## 测试场景

工作流会自动执行以下三种典型的 OLTP 场景测试:

1. **OLTP 读写混合测试** (`oltp_read_write`)
   - 模拟真实业务场景中的混合读写操作
   - 包括 SELECT、INSERT、UPDATE、DELETE 操作

2. **OLTP 只读测试** (`oltp_read_only`)
   - 测试数据库的读取性能
   - 纯 SELECT 查询操作

3. **OLTP 只写测试** (`oltp_write_only`)
   - 测试数据库的写入性能
   - INSERT、UPDATE、DELETE 操作

## 测试配置

### 默认参数

```yaml
TEST_DATABASE: "benchmark_db"
TEST_USER: "testuser"
TEST_PASSWORD: "testpass123"
SYSBENCH_THREADS: "4,8,16"        # 并发线程数
SYSBENCH_TABLES: "10"              # 测试表数量
SYSBENCH_TABLE_SIZE: "100000"     # 每张表的行数
SYSBENCH_TIME: "60"                # 每个测试的持续时间（秒）
```

### 数据库优化配置

#### PostgreSQL 优化参数
- `shared_buffers = 256MB`
- `effective_cache_size = 1GB`
- `maintenance_work_mem = 64MB`
- `checkpoint_completion_target = 0.9`
- `wal_buffers = 16MB`
- `work_mem = 4MB`
- `random_page_cost = 1.1`

#### MySQL (Percona) 优化参数
- `innodb_buffer_pool_size = 256M`
- `innodb_log_file_size = 64M`
- `innodb_flush_log_at_trx_commit = 2`
- `innodb_flush_method = O_DIRECT`
- `max_connections = 200`
- `query_cache_size = 0` (禁用查询缓存)

## 如何运行测试

### 方法 1: 手动触发

1. 进入 GitHub 仓库
2. 点击 `Actions` 标签
3. 选择 `PostgreSQL vs MySQL Performance Test` 工作流
4. 点击 `Run workflow` 按钮
5. 确认运行

### 方法 2: 定时自动运行

工作流配置为每周日凌晨 2 点 (UTC) 自动运行，无需手动干预。

## 测试报告

### 报告内容

测试完成后，会生成一份详细的中文性能对比报告，包括:

1. **测试环境信息**
   - 操作系统版本
   - CPU 和内存配置
   - 数据库版本

2. **测试配置参数**
   - 表数量和大小
   - 并发线程数
   - 测试持续时间

3. **性能指标对比表**
   - TPS (每秒事务数)
   - QPS (每秒查询数)
   - 平均延迟
   - 95% 延迟
   - 总事务数

4. **性能对比分析**
   - 各个线程数下的详细对比
   - 性能差异百分比
   - 优劣势分析

5. **总体性能总结**
   - PostgreSQL 优势场景
   - MySQL 优势场景
   - 使用建议

### 下载报告

测试完成后，可以在以下位置找到报告:

1. **GitHub Actions Artifacts**
   - 进入对应的 workflow run
   - 在页面底部的 `Artifacts` 部分下载 `performance-reports`
   
2. **GitHub Actions Summary**
   - 工作流运行页面会自动显示报告摘要

### 报告文件

- `性能对比报告_YYYYMMDD_HHMMSS.md` - 主要的 Markdown 格式报告
- `pg_*_threads_*.txt` - PostgreSQL 各项测试的详细日志
- `mysql_*_threads_*.txt` - MySQL 各项测试的详细日志

## 性能指标说明

### TPS (Transactions Per Second)
- **定义**: 每秒处理的事务数
- **意义**: 衡量数据库的事务处理能力
- **越高越好**

### QPS (Queries Per Second)
- **定义**: 每秒执行的查询数
- **意义**: 衡量数据库的查询处理能力
- **越高越好**

### 平均延迟 (Average Latency)
- **定义**: 所有请求的平均响应时间
- **单位**: 毫秒 (ms)
- **越低越好**

### 95% 延迟 (95th Percentile Latency)
- **定义**: 95% 的请求响应时间低于此值
- **意义**: 反映大多数用户的体验
- **越低越好**

## 注意事项

1. **测试环境**: GitHub Actions 提供的是共享资源，性能可能受其他任务影响
2. **真实场景**: 建议在接近生产环境的配置下进行更准确的性能测试
3. **数据规模**: 默认配置使用较小的数据集，大规模数据的性能表现可能不同
4. **负载模式**: Sysbench 的测试模式可能与实际业务负载有差异

## 自定义测试

如需修改测试参数，可以编辑 `.github/workflows/performance-test.yml` 文件中的 `env` 部分:

```yaml
env:
  SYSBENCH_THREADS: "4,8,16,32"     # 添加更多线程数
  SYSBENCH_TABLE_SIZE: "1000000"    # 增加表大小
  SYSBENCH_TIME: "120"              # 延长测试时间
```

## 参考资源

- [Sysbench 官方文档](https://github.com/akopytov/sysbench)
- [PostgreSQL 性能优化](https://www.postgresql.org/docs/current/performance-tips.html)
- [MySQL 性能优化](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
- [Percona Server 文档](https://www.percona.com/doc/percona-server/LATEST/index.html)

## 常见问题

### Q: 测试失败了怎么办？
A: 查看 GitHub Actions 的日志输出，通常是依赖安装或数据库启动问题。

### Q: 如何增加测试场景？
A: 可以在工作流中添加更多的测试步骤，Sysbench 支持多种测试类型。

### Q: 报告中的性能数据准确吗？
A: GitHub Actions 的环境是共享的，建议将此作为参考，在专用环境中验证。

### Q: 能否测试其他数据库？
A: 可以，只需修改工作流添加其他数据库的安装和配置步骤。

## 贡献

欢迎提交 Issue 或 Pull Request 来改进此性能测试框架。

## 许可证

本项目遵循 MIT 许可证。
