# PostgreSQL 16 性能优化配置文件
# 
# 适用于: 高性能 OLTP/OLAP 混合应用
# 内存: 64GB
# CPU: 14 cores
# 存储: NVMe SSD

# === 内存配置 ===
# 共享缓冲区 - 设置为可用内存的 25%
shared_buffers = 16GB

# 工作内存 - 每个查询操作可用的内存
work_mem = 256MB

# 维护工作内存 - 用于 VACUUM, CREATE INDEX 等操作
maintenance_work_mem = 2GB

# 有效缓存大小 - 告诉优化器可用的操作系统缓存大小
effective_cache_size = 48GB

# === 连接配置 ===
max_connections = 1000
superuser_reserved_connections = 10

# === WAL 写前日志配置 ===
wal_level = replica
wal_buffers = 64MB
wal_writer_delay = 200ms
wal_writer_flush_after = 1MB

# Checkpoint 配置
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
checkpoint_flush_after = 256kB
checkpoint_warning = 30s

# === 查询优化器配置 ===
# 随机页面成本 (SSD 存储)
random_page_cost = 1.1

# 顺序页面成本
seq_page_cost = 1.0

# CPU 成本参数
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# 统计信息目标
default_statistics_target = 500

# === 并发和锁配置 ===
# 有效的 I/O 并发
effective_io_concurrency = 200

# 最大并行工作进程
max_parallel_workers = 14
max_parallel_workers_per_gather = 4
max_parallel_maintenance_workers = 4

# 死锁超时
deadlock_timeout = 1s

# === 自动清理配置 ===
autovacuum = on
autovacuum_max_workers = 6
autovacuum_naptime = 15s
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# === 日志配置 ===
# 日志目标
log_destination = 'stderr,csvlog'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_rotation_age = 1d
log_rotation_size = 100MB

# 日志详细程度
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000

# 慢查询日志
log_statement = 'mod'
log_duration = off
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# === 连接和认证配置 ===
listen_addresses = '*'
port = 5432
max_prepared_transactions = 100

# 认证超时
authentication_timeout = 1min
password_encryption = scram-sha-256

# === 资源使用配置 ===
# 共享预加载库
shared_preload_libraries = 'pg_stat_statements'

# 临时文件
temp_file_limit = 10GB

# === 错误报告和日志记录 ===
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB

# === 运行时统计 ===
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl

# === 客户端连接默认值 ===
# 时区
timezone = 'Asia/Shanghai'
log_timezone = 'Asia/Shanghai'

# 字符集和本地化
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# 默认文本搜索配置
default_text_search_config = 'pg_catalog.english'

# === JIT 即时编译配置 ===
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# === 扩展配置 ===
# pg_stat_statements 扩展配置
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

# === 高级配置 ===
# 开启 huge pages (需要操作系统支持)
huge_pages = try

# 数据校验和
data_checksums = on

# === 备份和恢复配置 ===
# 归档模式
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
archive_timeout = 300s

# === 流复制配置 ===
max_wal_senders = 10
wal_keep_size = 16GB
hot_standby = on
hot_standby_feedback = on

# === JSON 支持配置 ===
# 启用 JSON 操作符和函数的优化
enable_hashjoin = on
enable_mergejoin = on

# === 分区表配置 ===
enable_partition_pruning = on
enable_partitionwise_join = on
enable_partitionwise_aggregate = on