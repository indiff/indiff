# MySQL 预编译包使用指南

## 快速开始

### 1. 下载预编译包

```bash
# 下载 MariaDB CentOS7 版本
curl -L -o maria-centos7.xz "https://github.com/indiff/indiff/releases/download/20250823_2217_mysql/maria-centos7-x86_64-20250823_2037.xz"

# 下载 Percona Server 8.0 CentOS7 版本  
curl -L -o percona80-centos7.xz "https://github.com/indiff/indiff/releases/download/20250823_2217_mysql/percona80-centos7-x86_64-20250823_2214.xz"

# 下载 Percona Server 8.0 Ubuntu 版本
curl -L -o percona80-ubuntu.xz "https://github.com/indiff/indiff/releases/download/20250823_2217_mysql/percona80-ubuntu-x86_64-20250823_1143.xz"
```

### 2. 解压安装包

⚠️ **注意**: 这些文件虽然以 `.xz` 为后缀，但实际为 ZIP 格式！

```bash
# 使用 unzip 解压 (不是 tar!)
unzip maria-centos7.xz -d /opt/mariadb
unzip percona80-centos7.xz -d /opt/percona80-centos7  
unzip percona80-ubuntu.xz -d /opt/percona80-ubuntu
```

### 3. 安装运行时依赖

#### Ubuntu/Debian 系统
```bash
sudo apt update
sudo apt install -y libaio1 libnuma1 libreadline8 libedit2 libtinfo6
```

#### CentOS/RHEL 系统  
```bash
sudo yum install -y libaio numactl-libs readline libedit ncurses-libs
```

### 4. 运行性能测试

使用提供的自动化测试脚本：

```bash
# 测试 Ubuntu 版本 Percona (推荐，依赖最完整)
./mysql_performance_test.sh percona80-ubuntu.xz

# 或者测试其他版本
./mysql_performance_test.sh maria-centos7.xz
./mysql_performance_test.sh percona80-centos7.xz
```

测试脚本会自动：
- ✅ 检查系统依赖
- ✅ 解压和配置 MySQL
- ✅ 运行性能基准测试
- ✅ 生成详细报告

## 手动部署指南

### 1. 基础配置

```bash
# 设置环境变量
export MYSQL_HOME="/opt/percona80-ubuntu"
export PATH="$MYSQL_HOME/bin:$PATH"

# 创建数据目录
sudo mkdir -p /var/lib/mysql
sudo chown $(whoami):$(whoami) /var/lib/mysql
```

### 2. 配置文件 (my.cnf)

```ini
[mysqld]
basedir = /opt/percona80-ubuntu
datadir = /var/lib/mysql
socket = /tmp/mysql.sock
port = 3306

# 基础性能配置
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2

# RocksDB 配置 (如果使用)
default-storage-engine = InnoDB
plugin-load-add = ha_rocksdb
rocksdb_default_cf_options = compression=snappy;bottommost_compression=zstd
rocksdb_block_cache_size = 512M

# 连接配置
max_connections = 500
max_connect_errors = 100000

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

[mysql]
default-character-set = utf8mb4

[client]
default-character-set = utf8mb4
socket = /tmp/mysql.sock
```

### 3. 初始化和启动

```bash
# 初始化数据库
$MYSQL_HOME/bin/mysqld --defaults-file=/etc/my.cnf --initialize-insecure

# 启动 MySQL 服务
$MYSQL_HOME/bin/mysqld --defaults-file=/etc/my.cnf &

# 等待启动完成
sleep 10

# 连接测试
$MYSQL_HOME/bin/mysql -u root -e "SELECT VERSION();"
```

## 存储引擎配置

### 启用 RocksDB 存储引擎

```sql
-- 安装 RocksDB 插件
INSTALL PLUGIN rocksdb SONAME 'ha_rocksdb.so';

-- 查看存储引擎状态
SHOW ENGINES;

-- 创建 RocksDB 表
CREATE TABLE test_rocksdb (
    id INT PRIMARY KEY,
    data TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=RocksDB 
COMMENT='compression=snappy';
```

### 配置压缩算法

```sql
-- 配置不同级别的压缩
SET GLOBAL rocksdb_default_cf_options = 
'compression_per_level=kNoCompression:kSnappyCompression:kZSTDCompression';

-- 查看压缩配置
SHOW VARIABLES LIKE 'rocksdb%compress%';
```

## 性能优化建议

### 1. 系统级优化

```bash
# 设置文件描述符限制
echo "mysql soft nofile 65536" >> /etc/security/limits.conf
echo "mysql hard nofile 65536" >> /etc/security/limits.conf

# 内存页面配置
echo "vm.swappiness = 1" >> /etc/sysctl.conf
echo "vm.dirty_ratio = 5" >> /etc/sysctl.conf

# 应用配置
sysctl -p
```

### 2. MySQL 配置调优

```ini
# 针对 SSD 存储的优化
innodb_io_capacity = 1000
innodb_io_capacity_max = 2000
innodb_flush_neighbors = 0

# 并发配置
innodb_thread_concurrency = 0
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# RocksDB 特定优化
rocksdb_max_background_jobs = 8
rocksdb_max_subcompactions = 4
rocksdb_allow_concurrent_memtable_write = ON
```

### 3. 应用层优化

```sql
-- 使用合适的存储引擎
-- 读密集型: InnoDB (更好的查询性能)
-- 写密集型: RocksDB (更好的写入性能)

-- 示例：日志表使用 RocksDB
CREATE TABLE app_logs (
    id BIGINT AUTO_INCREMENT,
    user_id INT,
    action VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id, created_at)
) ENGINE=RocksDB 
PARTITION BY RANGE(TO_DAYS(created_at)) (
    PARTITION p1 VALUES LESS THAN (TO_DAYS('2025-01-01')),
    PARTITION p2 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p3 VALUES LESS THAN MAXVALUE
);
```

## 监控和维护

### 1. 性能监控脚本

```bash
#!/bin/bash
# mysql_monitor.sh - MySQL 性能监控

echo "=== MySQL 状态监控 $(date) ==="

# 连接数监控
mysql -e "SHOW STATUS LIKE 'Threads_connected';"

# 存储引擎状态
mysql -e "SHOW ENGINE INNODB STATUS\G" | grep -A5 "BUFFER POOL"

# RocksDB 统计 (如果启用)
mysql -e "SHOW STATUS LIKE 'rocksdb%';" 2>/dev/null | head -10

# 慢查询监控
mysql -e "SHOW STATUS LIKE 'Slow_queries';"

echo "========================"
```

### 2. 日常维护任务

```sql
-- 表优化
OPTIMIZE TABLE your_table_name;

-- 索引分析
ANALYZE TABLE your_table_name;

-- RocksDB 压缩
SET GLOBAL rocksdb_force_flush_memtable_now = ON;
SET GLOBAL rocksdb_compact_cf = 'default';

-- 查看表空间使用
SELECT 
    table_schema,
    table_name,
    engine,
    ROUND(data_length/1024/1024, 2) AS data_mb,
    ROUND(index_length/1024/1024, 2) AS index_mb
FROM information_schema.tables
WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema')
ORDER BY data_length DESC;
```

## 故障排除

### 常见问题

1. **启动失败 - 缺少依赖库**
   ```bash
   # 检查缺少的依赖
   ldd $MYSQL_HOME/bin/mysqld | grep "not found"
   
   # 安装缺少的库
   sudo apt install -y <missing-package>
   ```

2. **RocksDB 插件加载失败**
   ```sql
   -- 检查插件文件
   SHOW VARIABLES LIKE 'plugin_dir';
   
   -- 手动加载插件
   INSTALL PLUGIN rocksdb SONAME 'ha_rocksdb.so';
   ```

3. **性能问题诊断**
   ```sql
   -- 查看慢查询
   SHOW VARIABLES LIKE 'slow_query_log%';
   
   -- 分析查询性能
   EXPLAIN ANALYZE SELECT * FROM your_table WHERE condition;
   
   -- 检查锁等待
   SHOW PROCESSLIST;
   ```

### 日志文件位置

```bash
# 错误日志
tail -f /var/lib/mysql/error.log

# 慢查询日志 (如果启用)
tail -f /var/lib/mysql/slow.log

# 二进制日志 (如果启用)
mysqlbinlog /var/lib/mysql/mysql-bin.000001
```

## 升级和迁移

### 从系统 MySQL 迁移

```bash
# 1. 备份现有数据
mysqldump --all-databases > backup.sql

# 2. 停止系统 MySQL
sudo systemctl stop mysql

# 3. 启动预编译版本
$MYSQL_HOME/bin/mysqld --defaults-file=/etc/my.cnf &

# 4. 恢复数据
$MYSQL_HOME/bin/mysql < backup.sql
```

### 版本间升级

```bash
# 升级前备份
mysqldump --all-databases --routines --triggers > full_backup.sql

# 升级后检查
mysql_upgrade --force

# 验证功能
mysql -e "SELECT VERSION(); SHOW ENGINES;"
```

这些预编译包提供了企业级的 MySQL 功能，特别适合需要高性能和新特性的应用场景。建议在生产环境使用前进行充分的测试和验证。