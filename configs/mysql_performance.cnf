# MySQL 性能优化配置文件
# 适用于MariaDB, Percona Server 8.0
# 基于8GB内存服务器的推荐配置

[mysqld]
# 基本设置
port = 3306
socket = /var/lib/mysql/mysql.sock
pid-file = /var/lib/mysql/mysql.pid
datadir = /var/lib/mysql
tmpdir = /tmp

# 字符集设置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init_connect = 'SET NAMES utf8mb4'

# 连接设置
max_connections = 1000
max_connect_errors = 999999
max_allowed_packet = 256M
connect_timeout = 10
wait_timeout = 600
interactive_timeout = 600

# 查询缓存 (MySQL 8.0中已移除)
query_cache_type = OFF
query_cache_size = 0

# 临时表设置
tmp_table_size = 256M
max_heap_table_size = 256M

# MyISAM 设置
key_buffer_size = 1G
read_buffer_size = 2M
read_rnd_buffer_size = 1M
sort_buffer_size = 4M
join_buffer_size = 4M

# InnoDB 设置 - 主要优化项
innodb_buffer_pool_size = 6G
innodb_buffer_pool_instances = 8
innodb_log_file_size = 512M
innodb_log_buffer_size = 64M
innodb_flush_log_at_trx_commit = 2
innodb_file_per_table = ON
innodb_open_files = 4000
innodb_io_capacity = 1000
innodb_io_capacity_max = 2000
innodb_flush_method = O_DIRECT
innodb_read_io_threads = 8
innodb_write_io_threads = 8
innodb_thread_concurrency = 0
innodb_lock_wait_timeout = 120
innodb_rollback_on_timeout = ON

# InnoDB 监控
innodb_monitor_enable = all
innodb_print_all_deadlocks = ON

# RocksDB 存储引擎配置
rocksdb_default_cf_options = write_buffer_size=128m;target_file_size_base=32m;max_bytes_for_level_base=512m;level0_file_num_compaction_trigger=4;level0_slowdown_writes_trigger=10;level0_stop_writes_trigger=15;max_write_buffer_number=4;compression_per_level=kNoCompression:kNoCompression:kLZ4Compression:kLZ4Compression:kLZ4Compression:kZSTD:kZSTD
rocksdb_max_open_files = 4000
rocksdb_max_background_jobs = 8
rocksdb_max_total_wal_size = 4G
rocksdb_block_cache_size = 2G
rocksdb_table_cache_numshardbits = 6

# ColumnStore 存储引擎配置
columnstore_use_import_for_batchinsert = ALWAYS
columnstore_diskjoin_smallsidelimit = 0
columnstore_diskjoin_bucketsize = 100
columnstore_diskjoin_largesidelimit = 0

# 二进制日志
log-bin = mysql-bin
binlog_format = ROW
max_binlog_size = 1G
expire_logs_days = 7
sync_binlog = 0

# 慢查询日志
slow_query_log = ON
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2.0
log_queries_not_using_indexes = ON
log_slow_admin_statements = ON

# 错误日志
log-error = /var/log/mysql/error.log

# 通用日志（生产环境建议关闭）
general_log = OFF
general_log_file = /var/log/mysql/mysql.log

# 性能优化
table_open_cache = 4000
table_definition_cache = 2000
open_files_limit = 65535

# 复制设置
server-id = 1
log-slave-updates = ON
relay-log = relay-bin
relay-log-index = relay-bin.index

# SSL设置（可选）
# ssl-ca = ca.pem
# ssl-cert = server-cert.pem
# ssl-key = server-key.pem

[mysql]
# 客户端设置
default-character-set = utf8mb4
socket = /var/lib/mysql/mysql.sock

[mysqldump]
# mysqldump设置
quick
quote-names
max_allowed_packet = 256M
default-character-set = utf8mb4

[client]
# 客户端通用设置
port = 3306
socket = /var/lib/mysql/mysql.sock
default-character-set = utf8mb4

# =====================================
# 针对不同场景的优化建议
# =====================================

# 高并发读取场景优化
# innodb_buffer_pool_size = 7G (内存的70-80%)
# innodb_read_io_threads = 16
# query_cache_type = ON (MySQL 5.7及之前版本)
# query_cache_size = 512M

# 高并发写入场景优化
# innodb_flush_log_at_trx_commit = 0 (牺牲一些安全性换取性能)
# innodb_log_buffer_size = 128M
# innodb_write_io_threads = 16
# sync_binlog = 0

# 大数据量场景优化
# sort_buffer_size = 8M
# read_buffer_size = 4M
# join_buffer_size = 8M
# bulk_insert_buffer_size = 64M

# SSD存储优化
# innodb_flush_method = O_DIRECT
# innodb_io_capacity = 2000
# innodb_io_capacity_max = 4000

# 内存存储引擎优化
# max_heap_table_size = 2G
# tmp_table_size = 2G

# RocksDB 存储引擎优化建议
# 高写入负载优化
# rocksdb_default_cf_options = write_buffer_size=256m;max_write_buffer_number=8;level0_file_num_compaction_trigger=8
# rocksdb_max_background_jobs = 16

# 高读取负载优化  
# rocksdb_block_cache_size = 4G
# rocksdb_table_cache_numshardbits = 8

# ColumnStore 存储引擎优化建议
# 大数据分析优化
# columnstore_diskjoin_smallsidelimit = 0
# columnstore_diskjoin_largesidelimit = 0
# columnstore_use_import_for_batchinsert = ALWAYS

# 文件系统优化建议
# XFS 文件系统 (推荐用于数据库)
# 挂载选项: noatime,largeio,inode64,swalloc

# EXT4 文件系统
# 挂载选项: noatime,data=writeback,barrier=0,nobh

# BTRFS 文件系统 (适合快照和压缩)
# 挂载选项: noatime,compress=lzo,space_cache,autodefrag